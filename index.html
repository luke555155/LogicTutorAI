<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測驗作答系統</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 自訂 Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        accent: '#3b82f6',
                        success: '#22c55e',
                        danger: '#ef4444',
                        warm: '#f59e0b'
                    },
                    fontFamily: {
                        display: ['Noto Sans TC', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace']
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Noto Sans TC', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        
        /* 答題卡格子動畫 */
        .answer-card-item {
            transition: all 0.2s ease;
        }
        .answer-card-item:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        /* 選項動畫 */
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn:hover:not(.answered) {
            transform: translateX(8px);
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* 正確答案閃爍 */
        @keyframes correctPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
        .correct-answer {
            animation: correctPulse 0.6s ease;
        }
        
        /* 載入動畫 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* 捲軸樣式 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* 多選題核取方塊 */
        .checkbox-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #475569;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .checkbox-custom:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .checkbox-custom:checked::after {
            content: '✓';
            display: block;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 16px;
        }

        /* 懸浮解析視窗樣式 */
        .floating-panel {
            position: fixed;
            z-index: 1000;
            min-width: 320px;
            max-width: 480px;
            max-height: 80vh;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(251, 191, 36, 0.2);
            border-radius: 16px;
            overflow: hidden;
            resize: both;
            display: flex;
            flex-direction: column;
        }

        .floating-panel-header {
            cursor: move;
            user-select: none;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(234, 88, 12, 0.2) 100%);
            border-bottom: 1px solid rgba(251, 191, 36, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .floating-panel-header:active {
            cursor: grabbing;
        }

        .floating-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: rgba(15, 23, 42, 0.98);
        }

        /* 解析面板 Markdown 渲染樣式 */
        .explanation-content {
            color: #e2e8f0;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .explanation-content h1,
        .explanation-content h2,
        .explanation-content h3,
        .explanation-content h4,
        .explanation-content h5,
        .explanation-content h6 {
            color: #fbbf24;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .explanation-content h1 { font-size: 1.5rem; }
        .explanation-content h2 { font-size: 1.25rem; }
        .explanation-content h3 { font-size: 1.125rem; }
        .explanation-content h4,
        .explanation-content h5,
        .explanation-content h6 { font-size: 1rem; }

        .explanation-content p {
            margin-bottom: 0.875rem;
        }

        .explanation-content strong {
            color: #fbbf24;
            font-weight: 600;
        }

        .explanation-content em {
            color: #94a3b8;
            font-style: italic;
        }

        .explanation-content code {
            background: #334155;
            color: #f472b6;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
        }

        .explanation-content pre {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .explanation-content pre code {
            background: transparent;
            padding: 0;
            color: #e2e8f0;
        }

        .explanation-content blockquote {
            border-left: 4px solid #fbbf24;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #94a3b8;
            font-style: italic;
        }

        .explanation-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.85rem;
        }
        .explanation-content th,
        .explanation-content td {
            border: 1px solid #475569;
            padding: 0.625rem 0.75rem;
            text-align: left;
        }
        .explanation-content th {
            background: #334155;
            color: #fbbf24;
            font-weight: 600;
        }
        .explanation-content tr:nth-child(even) {
            background: rgba(51, 65, 85, 0.5);
        }
        .explanation-content tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .explanation-content ul,
        .explanation-content ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
        }
        .explanation-content li {
            margin-bottom: 0.375rem;
        }
        .explanation-content li::marker {
            color: #fbbf24;
        }

        .explanation-content hr {
            border: none;
            border-top: 1px solid #475569;
            margin: 1.5rem 0;
        }

        .explanation-content a {
            color: #60a5fa;
            text-decoration: underline;
        }
        .explanation-content a:hover {
            color: #93c5fd;
        }

        .explanation-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- 主容器 -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- 頂部導航列 -->
        <header class="bg-slate-900/80 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg flex items-center justify-center font-bold text-lg">
                        L+
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">測驗作答系統</h1>
                        <p class="text-xs text-slate-400">Markdown 題庫練習工具</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- 檔案選擇按鈕 -->
                    <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        載入題庫
                        <input type="file" id="fileInput" accept=".md" class="hidden" onchange="loadFileFromInput(event)">
                    </label>
                    <!-- 重新載入按鈕 -->
                    <button onclick="reloadQuestions()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        重新載入
                    </button>
                    <!-- 設定按鈕 -->
                    <button onclick="openSettingsDialog()" class="bg-slate-700 hover:bg-slate-600 p-2 rounded-lg transition" title="AI 設定">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主內容區 -->
        <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6">
            <!-- 載入中狀態 -->
            <div id="loadingState" class="flex flex-col items-center justify-center py-20">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full loading-spinner mb-4"></div>
                <p class="text-slate-400">正在載入題庫...</p>
            </div>

            <!-- 無題庫狀態 -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
                <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-white mb-2">尚未載入題庫</h2>
                <p class="text-slate-400 mb-6 text-center">請點擊上方「載入題庫」按鈕選擇 Markdown 題庫檔案<br>或將 <code class="bg-slate-700 px-2 py-0.5 rounded text-sm">database.md</code> 放在同目錄下</p>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-medium transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        選擇題庫檔案
                        <input type="file" accept=".md" class="hidden" onchange="loadFileFromInput(event)">
                    </label>
                    <a href="sampleMd/sample.md" download class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg font-medium transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        下載 MD 格式範本
                    </a>
                </div>
            </div>

            <!-- 題目區域 -->
            <div id="quizContainer" class="hidden grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- 左側：題目區 -->
                <div class="lg:col-span-3 space-y-4">
                    <!-- 導航按鈕（移至題目卡片上方） -->
                    <div class="flex items-center justify-between bg-slate-800/30 backdrop-blur rounded-xl px-4 py-3 border border-slate-700/50">
                        <button onclick="prevQuestion()" id="prevBtn" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-5 py-2.5 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                            上一題
                        </button>
                        
                        <!-- 快速跳題 -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">跳至第</span>
                            <input type="number" id="jumpInput" min="1" class="w-20 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-center text-white focus:outline-none focus:border-blue-500" onkeypress="if(event.key==='Enter')jumpToQuestion()">
                            <span class="text-slate-400 text-sm">題</span>
                            <button onclick="jumpToQuestion()" class="bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded-lg text-sm transition">跳轉</button>
                        </div>
                        
                        <button onclick="nextQuestion()" id="nextBtn" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-5 py-2.5 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed">
                            下一題
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- 題目卡片 -->
                    <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 overflow-hidden">
                        <!-- 題目頭部 -->
                        <div class="bg-slate-800 px-6 py-4 border-b border-slate-700 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <!-- 解析提示按鈕（有解析時才顯示） -->
                                <button id="explanationBtn" onclick="toggleExplanationPanel()" class="hidden w-9 h-9 flex items-center justify-center rounded-lg bg-amber-500/20 hover:bg-amber-500/40 border border-amber-500/50 transition group" title="查看題目解析">
                                    <svg class="w-5 h-5 text-amber-400 group-hover:text-amber-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                </button>
                                <span id="questionNumber" class="text-lg font-bold text-white">第 1 題 / 611 題</span>
                                <span id="questionType" class="px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full text-sm font-medium">單選題</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- 查看圖片按鈕（附圖片題才顯示） -->
                                <button id="viewImageBtn" onclick="openImageDialog()" class="hidden bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <span>查看圖片</span>
                                </button>
                                <!-- 翻譯按鈕 -->
                                <button id="translateBtn" onclick="toggleTranslation()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                                    </svg>
                                    <span id="translateBtnText">顯示中文翻譯</span>
                                </button>
                                <!-- AI 解析按鈕 -->
                                <button id="aiAnalyzeBtn" onclick="analyzeWithAI()" class="bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-500 hover:to-pink-400 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-lg shadow-purple-500/25">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    <span>AI 解析</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 題目內容 -->
                        <div class="p-6">
                            <!-- 圖片區（如有） -->
                            <div id="questionImage" class="hidden mb-6">
                                <img id="questionImageSrc" src="" alt="題目圖片" class="max-w-full rounded-lg border border-slate-600">
                            </div>
                            
                            <!-- 題目文字 -->
                            <div id="questionText" class="text-lg text-gray-200 leading-relaxed mb-8">
                                <!-- 動態載入題目 -->
                            </div>
                            
                            <!-- 選項區 -->
                            <div id="optionsContainer" class="space-y-3">
                                <!-- 動態載入選項 -->
                            </div>
                            
                            <!-- 多選題提交按鈕 -->
                            <div id="submitBtnContainer" class="hidden mt-6">
                                <button onclick="submitMultipleChoice()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 py-3 rounded-xl font-semibold text-white transition shadow-lg shadow-blue-500/25">
                                    提交答案
                                </button>
                            </div>
                            
                            <!-- 答題結果提示 -->
                            <div id="resultMessage" class="hidden mt-6 p-4 rounded-xl">
                                <!-- 動態顯示結果 -->
                            </div>
                            
                            <!-- AI 解析結果區塊 -->
                            <div id="aiAnalysisSection" class="hidden mt-6">
                                <div class="border border-purple-500/30 rounded-xl overflow-hidden">
                                    <!-- 區塊標題 -->
                                    <div class="bg-gradient-to-r from-purple-600/20 to-pink-500/20 px-5 py-3 border-b border-purple-500/30 flex items-center justify-between">
                                        <h4 class="font-semibold text-white flex items-center gap-2">
                                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                            </svg>
                                            AI 解析
                                        </h4>
                                        <button onclick="hideAiAnalysis()" class="text-slate-400 hover:text-white transition p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <!-- 載入中狀態 -->
                                    <div id="aiAnalysisLoading" class="hidden p-8 text-center bg-slate-900/50">
                                        <div class="w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full loading-spinner mx-auto mb-3"></div>
                                        <p class="text-slate-400 text-sm">AI 正在分析題目...</p>
                                    </div>
                                    <!-- 解析內容 -->
                                    <div id="aiAnalysisContent" class="hidden p-6 bg-slate-900/50 text-gray-200">
                                        <!-- 動態載入 AI 回覆 -->
                                    </div>
                                    <!-- 錯誤訊息 -->
                                    <div id="aiAnalysisError" class="hidden p-6 bg-slate-900/50 text-center">
                                        <p id="aiAnalysisErrorMsg" class="text-red-400 mb-3">發生錯誤</p>
                                        <button onclick="analyzeWithAI()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm transition">重試</button>
                                    </div>
                                    <!-- 底部提示 -->
                                    <div class="px-5 py-2 bg-slate-800/50 border-t border-purple-500/20">
                                        <p class="text-xs text-slate-500 text-center">由 GROQ AI 提供分析 | 結果僅供參考</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右側：答題卡與統計 -->
                <div class="space-y-4">
                    <!-- 統計卡片 -->
                    <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 p-5">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            答題統計
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">答對</span>
                                <span id="correctCount" class="text-2xl font-bold text-green-400">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">答錯</span>
                                <span id="wrongCount" class="text-2xl font-bold text-red-400">0</span>
                            </div>
                            <div class="h-px bg-slate-700 my-2"></div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">正確率</span>
                                <span id="accuracy" class="text-2xl font-bold text-blue-400">0%</span>
                            </div>
                            <!-- 進度條 -->
                            <div class="mt-3">
                                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div id="progressBar" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="progressText" class="text-xs text-slate-500 mt-1 text-center">已作答 0 / 0 題</p>
                            </div>
                        </div>
                        <!-- 重設按鈕 -->
                        <button onclick="resetProgress()" class="w-full mt-4 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm font-medium transition">
                            重設進度
                        </button>
                    </div>
                    
                    <!-- 答題卡 -->
                    <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 p-5">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            答題卡
                        </h3>
                        <div id="answerCard" class="flex flex-wrap max-h-80 overflow-y-auto overflow-x-hidden pr-1" style="gap: 3px;">
                            <!-- 動態生成題號格子 -->
                        </div>
                        <!-- 圖例 -->
                        <div class="mt-4 flex items-center justify-center gap-4 text-xs text-slate-400">
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-green-500 rounded"></div>
                                <span>正確</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-red-500 rounded"></div>
                                <span>錯誤</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-slate-600 rounded"></div>
                                <span>未作答</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 懸浮解析視窗 -->
        <div id="explanationPanel" class="floating-panel hidden" style="left: 16px; top: 100px; width: 400px; height: 500px;">
            <!-- 視窗標題列（可拖曳） -->
            <div class="floating-panel-header" id="explanationPanelHeader">
                <h4 class="font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <span>題目解析</span>
                    <span id="explanationQuestionNum" class="text-xs text-amber-400/70 ml-1"></span>
                </h4>
                <button onclick="closeExplanationPanel()" class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-500/30 transition text-slate-400 hover:text-red-400" title="關閉 (ESC)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <!-- 解析內容 -->
            <div class="floating-panel-body">
                <div id="explanationContent" class="explanation-content">
                    <!-- 動態載入 Markdown 解析後的 HTML -->
                </div>
            </div>
        </div>

        <!-- 圖片 Dialog 彈窗 -->
        <div id="imageDialog" class="fixed inset-0 z-[100] hidden" onclick="handleDialogBackdropClick(event)">
            <!-- 背景遮罩 -->
            <div class="absolute inset-0 bg-black/85 backdrop-blur-sm"></div>
            <!-- Dialog 內容 -->
            <div class="absolute inset-0 flex items-center justify-center p-4 md:p-10 pointer-events-none">
                <div class="relative bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-4xl max-h-full overflow-hidden flex flex-col pointer-events-auto" onclick="event.stopPropagation()">
                    <!-- Dialog 頭部 -->
                    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800 shrink-0">
                        <h3 class="text-base font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            題目圖片
                        </h3>
                        <!-- 縮放控制按鈕 -->
                        <div class="flex items-center gap-2">
                            <button onclick="zoomOut()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-700 hover:bg-slate-600 transition text-slate-300 hover:text-white" title="縮小">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                </svg>
                            </button>
                            <span id="zoomLevel" class="text-sm text-slate-400 w-14 text-center">100%</span>
                            <button onclick="zoomIn()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-700 hover:bg-slate-600 transition text-slate-300 hover:text-white" title="放大">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            </button>
                            <button onclick="resetZoom()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-700 hover:bg-slate-600 transition text-slate-300 hover:text-white ml-1" title="重設">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                            <div class="w-px h-6 bg-slate-600 mx-2"></div>
                            <button onclick="closeImageDialog()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-600/80 hover:bg-red-500 transition text-white" title="關閉">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- 圖片容器（支援拖曳） -->
                    <div id="imageContainer" class="min-h-[50vh] max-h-[70vh] overflow-auto bg-slate-950 cursor-grab active:cursor-grabbing relative" 
                         onmousedown="startDrag(event)" onmousemove="onDrag(event)" onmouseup="endDrag()" onmouseleave="endDrag()"
                         onwheel="handleWheel(event)">
                        <div id="imageWrapper" class="w-full h-full flex items-center justify-center" style="min-height: 50vh;">
                            <img id="dialogImageSrc" src="" alt="題目圖片" 
                                 class="max-w-full max-h-[65vh] object-contain select-none pointer-events-none shadow-2xl rounded"
                                 style="transform-origin: center center; will-change: transform;"
                                 draggable="false">
                        </div>
                    </div>
                    <!-- Dialog 底部提示 -->
                    <div class="px-4 py-2 border-t border-slate-700 bg-slate-800 text-center shrink-0">
                        <p class="text-xs text-slate-500">滾輪縮放 | 拖曳移動 | <kbd class="px-1.5 py-0.5 bg-slate-700 rounded text-xs">ESC</kbd> 關閉</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 設定 Dialog -->
        <div id="settingsDialog" class="fixed inset-0 z-[100] hidden" onclick="handleSettingsBackdropClick(event)">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
                <div class="relative bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-md pointer-events-auto" onclick="event.stopPropagation()">
                    <!-- Dialog 頭部 -->
                    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700 bg-slate-800 rounded-t-2xl">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            AI 設定 (GROQ)
                        </h3>
                        <button onclick="closeSettingsDialog()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-700 transition text-slate-400 hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Dialog 內容 -->
                    <div class="p-6 space-y-5">
                        <!-- API Key 輸入 -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">GROQ API Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="groqApiKeyInput" placeholder="gsk_xxxxxxxxxxxxxxxx" 
                                       class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                <button onclick="verifyApiKey()" id="verifyApiKeyBtn" class="bg-blue-600 hover:bg-blue-500 px-4 py-2.5 rounded-lg font-medium transition flex items-center gap-2 shrink-0">
                                    <span id="verifyBtnText">確認</span>
                                    <div id="verifySpinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full loading-spinner"></div>
                                </button>
                            </div>
                            <p id="apiKeyStatus" class="mt-2 text-xs text-slate-500">輸入 API Key 後點擊確認以載入模型列表</p>
                        </div>
                        
                        <!-- 模型選擇（預設隱藏） -->
                        <div id="modelSelectContainer" class="hidden">
                            <label class="block text-sm font-medium text-slate-300 mb-2">選擇模型</label>
                            <div class="relative">
                                <input type="text" id="modelSearchInput" placeholder="搜尋模型..." 
                                       class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500"
                                       oninput="filterModels()" onfocus="showModelDropdown()" autocomplete="off">
                                <div id="modelDropdown" class="hidden absolute left-0 right-0 top-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl max-h-48 overflow-y-auto z-10">
                                    <!-- 動態載入模型列表 -->
                                </div>
                            </div>
                            <p id="selectedModelDisplay" class="mt-2 text-xs text-slate-400">已選擇：<span id="currentModelName" class="text-blue-400">未選擇</span></p>
                        </div>
                        
                        <!-- 進階設定（預設隱藏） -->
                        <div id="advancedSettingsContainer" class="hidden">
                            <div class="border-t border-slate-700 pt-5">
                                <!-- 進階設定標題（可展開/收合） -->
                                <button onclick="toggleAdvancedSettings()" class="w-full flex items-center justify-between text-left mb-3">
                                    <label class="text-sm font-medium text-slate-300 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                                        </svg>
                                        進階設定
                                    </label>
                                    <svg id="advancedSettingsIcon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                                
                                <!-- 進階設定內容（預設隱藏） -->
                                <div id="advancedSettingsContent" class="hidden">
                                    <label class="block text-sm font-medium text-slate-300 mb-2">自訂提示詞</label>
                                    <div class="space-y-2">
                                        <textarea id="customPromptInput" rows="8" 
                                                  placeholder="請使用系統原生提示詞"
                                                  class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-y font-mono"
                                                  style="min-height: 150px;"></textarea>
                                        <div class="flex items-center justify-between">
                                            <p class="text-xs text-slate-500">留空將使用系統預設提示詞</p>
                                            <div class="flex items-center gap-2">
                                                <button onclick="loadSystemPrompt()" class="bg-blue-600/80 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-1.5">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0L8 8m4-4v12"/>
                                                    </svg>
                                                    載入系統預設
                                                </button>
                                                <button onclick="resetCustomPrompt()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium transition flex items-center gap-1.5">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                                    </svg>
                                                    清空
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Dialog 底部 -->
                    <div class="px-6 py-4 border-t border-slate-700 bg-slate-800/50 rounded-b-2xl flex justify-end gap-3">
                        <button onclick="closeSettingsDialog()" class="px-4 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition">取消</button>
                        <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-medium transition">儲存設定</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 頁尾 -->
        <footer class="bg-slate-900/50 border-t border-slate-800 py-4">
            <p class="text-center text-slate-500 text-sm">
                測驗作答系統 | Markdown 題庫練習工具
            </p>
        </footer>
    </div>

    <script>
        // ==================== 全域狀態 ====================
        let questions = [];           // 所有題目
        let currentIndex = 0;         // 當前題目索引
        let showChinese = false;      // 是否顯示中文
        let answerState = {};         // 答題狀態 { questionNum: 'correct' | 'wrong' }
        let selectedOptions = [];     // 多選題已選選項
        let hasAnswered = false;      // 當前題目是否已作答

        // GROQ AI 設定
        let groqApiKey = '';          // GROQ API Key
        let groqModel = 'openai/gpt-oss-20b';  // 預設模型
        let availableModels = [];     // 可用模型列表

        // ==================== 題庫解析器 ====================
        /**
         * 解析 Markdown 題庫檔案
         * @param {string} markdown - Markdown 原始內容
         * @returns {Array} 題目陣列
         */
        function parseQuestions(markdown) {
            const questions = [];
            // 以 --- 分隔各題
            const blocks = markdown.split(/---/).filter(block => block.trim());
            
            for (const block of blocks) {
                // 解析題號與題型
                const headerMatch = block.match(/##\s*第\s*(\d+)\s*題\s*【(單選題|多選題)】/);
                if (!headerMatch) continue;
                
                const questionNum = parseInt(headerMatch[1]);
                const questionType = headerMatch[2];
                const isMultiple = questionType === '多選題';
                
                // 解析英文題目
                const englishMatch = block.match(/\*\*English:\*\*\s*([\s\S]*?)(?=\*\*中文：\*\*)/);
                const englishText = englishMatch ? englishMatch[1].trim() : '';
                
                // 解析中文題目
                const chineseMatch = block.match(/\*\*中文：\*\*\s*([\s\S]*?)(?=(?:\!\[圖片\]|\*\*選項：\*\*))/);
                const chineseText = chineseMatch ? chineseMatch[1].trim() : '';
                
                // 解析圖片
                const imageMatch = block.match(/!\[圖片\]\((.*?)\)/);
                const imagePath = imageMatch ? imageMatch[1] : null;
                
                // 解析選項
                const optionsMatch = block.match(/\*\*選項：\*\*\s*([\s\S]*?)(?=\*\*正確答案)/);
                const optionsText = optionsMatch ? optionsMatch[1].trim() : '';
                const optionLines = optionsText.split('\n').filter(line => line.trim().startsWith('-'));
                
                const options = optionLines.map(line => {
                    // 移除開頭的 "- " 並解析選項
                    const cleaned = line.replace(/^-\s*/, '').trim();
                    const letterMatch = cleaned.match(/^([A-F])\.\s*(.*)/);
                    if (letterMatch) {
                        return {
                            letter: letterMatch[1],
                            text: letterMatch[2]
                        };
                    }
                    return null;
                }).filter(opt => opt !== null);
                
                // 解析正確答案
                const answerMatch = block.match(/\*\*正確答案：([A-F]+)\*\*/);
                const correctAnswer = answerMatch ? answerMatch[1] : '';

                // 解析題目解析（可選欄位）
                const explanationMatch = block.match(/\*\*題目解析\*\*\s*([\s\S]*?)(?=$)/);
                const explanation = explanationMatch ? explanationMatch[1].trim() : null;

                questions.push({
                    number: questionNum,
                    type: questionType,
                    isMultiple,
                    englishText,
                    chineseText,
                    imagePath,
                    options,
                    correctAnswer,
                    explanation
                });
            }
            
            // 依題號排序
            questions.sort((a, b) => a.number - b.number);
            return questions;
        }

        // ==================== 題庫載入 ====================
        /**
         * 嘗試自動載入同目錄下的題庫檔案
         */
        async function autoLoadQuestions() {
            try {
                const response = await fetch('database.md');
                if (response.ok) {
                    const markdown = await response.text();
                    questions = parseQuestions(markdown);
                    if (questions.length > 0) {
                        loadSavedProgress();
                        initQuiz();
                        return;
                    }
                }
            } catch (e) {
                console.log('自動載入失敗，等待手動選擇檔案');
            }
            // 顯示空狀態
            showEmptyState();
        }

        /**
         * 從檔案輸入載入題庫
         */
        function loadFileFromInput(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoadingState();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const markdown = e.target.result;
                questions = parseQuestions(markdown);
                if (questions.length > 0) {
                    loadSavedProgress();
                    initQuiz();
                } else {
                    alert('無法解析題庫檔案，請確認格式正確');
                    showEmptyState();
                }
            };
            reader.readAsText(file);
        }

        /**
         * 重新載入題庫
         */
        async function reloadQuestions() {
            showLoadingState();
            try {
                const response = await fetch('database.md', { cache: 'no-cache' });
                if (response.ok) {
                    const markdown = await response.text();
                    questions = parseQuestions(markdown);
                    if (questions.length > 0) {
                        loadSavedProgress();
                        initQuiz();
                        return;
                    }
                }
            } catch (e) {
                console.log('重新載入失敗');
            }
            alert('重新載入失敗，請使用「載入題庫」按鈕手動選擇檔案');
            showQuizContainer();
        }

        // ==================== 狀態顯示 ====================
        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
        }

        function showEmptyState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
        }

        function showQuizContainer() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');
        }

        // ==================== 題目初始化與渲染 ====================
        /**
         * 初始化測驗
         */
        function initQuiz() {
            showQuizContainer();
            generateAnswerCard();
            renderQuestion();
            updateStats();
            updateJumpInputMax();
        }

        /**
         * 生成答題卡格子
         */
        function generateAnswerCard() {
            const container = document.getElementById('answerCard');
            container.innerHTML = '';
            
            for (let i = 0; i < questions.length; i++) {
                const num = questions[i].number;
                const div = document.createElement('div');
                div.className = 'answer-card-item w-8 h-8 flex items-center justify-center text-xs font-medium rounded cursor-pointer transition-colors';
                div.textContent = num;
                div.dataset.index = i;
                
                // 設定顏色
                updateCardItemColor(div, num);
                
                // 點擊跳轉
                div.onclick = () => {
                    currentIndex = i;
                    renderQuestion();
                };
                
                container.appendChild(div);
            }
        }

        /**
         * 更新答題卡格子顏色
         */
        function updateCardItemColor(element, questionNum) {
            const state = answerState[questionNum];
            element.classList.remove('bg-green-500', 'bg-red-500', 'bg-slate-600', 'text-white', 'text-slate-400');
            
            if (state === 'correct') {
                element.classList.add('bg-green-500', 'text-white');
            } else if (state === 'wrong') {
                element.classList.add('bg-red-500', 'text-white');
            } else {
                element.classList.add('bg-slate-600', 'text-slate-300');
            }
        }

        /**
         * 更新單一答題卡格子
         */
        function updateSingleCardItem(questionNum) {
            const container = document.getElementById('answerCard');
            const items = container.querySelectorAll('.answer-card-item');
            items.forEach(item => {
                if (parseInt(item.textContent) === questionNum) {
                    updateCardItemColor(item, questionNum);
                }
            });
        }

        /**
         * 渲染當前題目
         */
        function renderQuestion() {
            if (questions.length === 0) return;
            
            const q = questions[currentIndex];
            hasAnswered = !!answerState[q.number];
            selectedOptions = [];
            
            // 隱藏 AI 解析區塊（切換題目時重設）
            document.getElementById('aiAnalysisSection').classList.add('hidden');

            // 關閉解析面板（切換題目時重設）
            if (isExplanationPanelOpen) {
                closeExplanationPanel();
            }

            // 顯示/隱藏解析提示按鈕（只有有解析的題目才顯示）
            const explanationBtn = document.getElementById('explanationBtn');
            if (q.explanation) {
                explanationBtn.classList.remove('hidden');
                explanationBtn.classList.add('flex');
            } else {
                explanationBtn.classList.add('hidden');
                explanationBtn.classList.remove('flex');
            }

            // 更新題號
            document.getElementById('questionNumber').textContent = `第 ${q.number} 題 / ${questions.length} 題`;
            
            // 更新題型
            const typeEl = document.getElementById('questionType');
            typeEl.textContent = q.type;
            typeEl.className = 'px-3 py-1 rounded-full text-sm font-medium ' + 
                (q.isMultiple ? 'bg-purple-600/20 text-purple-400' : 'bg-blue-600/20 text-blue-400');
            
            // 顯示/隱藏查看圖片按鈕（附圖片題才顯示）
            const viewImageBtn = document.getElementById('viewImageBtn');
            if (q.imagePath) {
                viewImageBtn.classList.remove('hidden');
                viewImageBtn.classList.add('flex');
                // 設定 Dialog 圖片路徑
                document.getElementById('dialogImageSrc').src = q.imagePath;
            } else {
                viewImageBtn.classList.add('hidden');
                viewImageBtn.classList.remove('flex');
            }
            
            // 隱藏內嵌圖片區域（改用 Dialog 顯示）
            const imageContainer = document.getElementById('questionImage');
            imageContainer.classList.add('hidden');
            
            // 顯示題目文字
            const questionText = showChinese ? q.chineseText : q.englishText;
            document.getElementById('questionText').innerHTML = escapeHtml(questionText);
            
            // 更新翻譯按鈕狀態
            document.getElementById('translateBtnText').textContent = showChinese ? '顯示英文原文' : '顯示中文翻譯';
            
            // 渲染選項
            renderOptions(q);
            
            // 顯示/隱藏多選題提交按鈕
            const submitBtnContainer = document.getElementById('submitBtnContainer');
            if (q.isMultiple && !hasAnswered) {
                submitBtnContainer.classList.remove('hidden');
            } else {
                submitBtnContainer.classList.add('hidden');
            }
            
            // 隱藏結果訊息
            document.getElementById('resultMessage').classList.add('hidden');
            
            // 更新導航按鈕狀態
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === questions.length - 1;
            
            // 更新跳題輸入框
            document.getElementById('jumpInput').value = q.number;
            
            // 如果已作答，顯示結果
            if (hasAnswered) {
                showAnswerResult(q, answerState[q.number] === 'correct');
            }
        }

        /**
         * 渲染選項
         */
        function renderOptions(question) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            const correctLetters = question.correctAnswer.split('');
            
            question.options.forEach(opt => {
                const isCorrect = correctLetters.includes(opt.letter);
                
                const div = document.createElement('div');
                div.className = 'option-btn flex items-center gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all';
                div.dataset.letter = opt.letter;
                
                // 根據已作答狀態設定樣式
                if (hasAnswered) {
                    div.classList.add('answered', 'cursor-default');
                    if (isCorrect) {
                        div.classList.add('border-green-500', 'bg-green-500/10');
                    } else {
                        div.classList.add('border-slate-600', 'bg-slate-800/50');
                    }
                } else {
                    div.classList.add('border-slate-600', 'bg-slate-800/50', 'hover:border-blue-500');
                }
                
                // 多選題使用核取方塊
                if (question.isMultiple) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'checkbox-custom';
                    checkbox.disabled = hasAnswered;
                    checkbox.dataset.letter = opt.letter;
                    checkbox.onchange = (e) => {
                        e.stopPropagation();
                        if (e.target.checked) {
                            selectedOptions.push(opt.letter);
                        } else {
                            selectedOptions = selectedOptions.filter(l => l !== opt.letter);
                        }
                    };
                    div.appendChild(checkbox);
                    
                    // 點擊選項也能切換核取方塊
                    if (!hasAnswered) {
                        div.onclick = () => {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        };
                    }
                } else {
                    // 單選題使用圓形指示器
                    const indicator = document.createElement('div');
                    indicator.className = 'w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold text-sm shrink-0';
                    if (hasAnswered && isCorrect) {
                        indicator.classList.add('border-green-500', 'bg-green-500', 'text-white');
                    } else {
                        indicator.classList.add('border-slate-500', 'text-slate-400');
                    }
                    indicator.textContent = opt.letter;
                    div.appendChild(indicator);
                    
                    // 單選題點擊事件
                    if (!hasAnswered) {
                        div.onclick = () => selectSingleOption(opt.letter, question);
                    }
                }
                
                // 選項文字
                const textSpan = document.createElement('span');
                textSpan.className = 'flex-1';
                // 解析選項中的中英文
                if (showChinese) {
                    // 嘗試提取中文部分（括號內）
                    const chineseMatch = opt.text.match(/（(.+?)）/);
                    textSpan.textContent = chineseMatch ? `${opt.letter}. ${chineseMatch[1]}` : `${opt.letter}. ${opt.text}`;
                } else {
                    // 只顯示英文部分
                    const englishText = opt.text.replace(/（.+?）/, '').trim();
                    textSpan.textContent = `${opt.letter}. ${englishText}`;
                }
                div.appendChild(textSpan);
                
                container.appendChild(div);
            });
        }

        /**
         * 單選題選擇選項
         */
        function selectSingleOption(letter, question) {
            if (hasAnswered) return;
            
            const isCorrect = letter === question.correctAnswer;
            hasAnswered = true;
            answerState[question.number] = isCorrect ? 'correct' : 'wrong';
            
            saveProgress();
            updateSingleCardItem(question.number);
            updateStats();
            
            // 重新渲染選項以顯示結果
            renderOptions(question);
            showAnswerResult(question, isCorrect, letter);
            
            // 答對自動跳下一題
            if (isCorrect && currentIndex < questions.length - 1) {
                setTimeout(() => {
                    nextQuestion();
                }, 800);
            }
        }

        /**
         * 多選題提交答案
         */
        function submitMultipleChoice() {
            const q = questions[currentIndex];
            if (hasAnswered || selectedOptions.length === 0) return;
            
            // 排序後比較
            const userAnswer = selectedOptions.sort().join('');
            const correctAnswer = q.correctAnswer.split('').sort().join('');
            const isCorrect = userAnswer === correctAnswer;
            
            hasAnswered = true;
            answerState[q.number] = isCorrect ? 'correct' : 'wrong';
            
            saveProgress();
            updateSingleCardItem(q.number);
            updateStats();
            
            // 隱藏提交按鈕
            document.getElementById('submitBtnContainer').classList.add('hidden');
            
            // 重新渲染選項以顯示結果
            renderOptions(q);
            showAnswerResult(q, isCorrect, userAnswer);
            
            // 答對自動跳下一題
            if (isCorrect && currentIndex < questions.length - 1) {
                setTimeout(() => {
                    nextQuestion();
                }, 800);
            }
        }

        /**
         * 顯示答題結果
         */
        function showAnswerResult(question, isCorrect, userAnswer = '') {
            const resultEl = document.getElementById('resultMessage');
            resultEl.classList.remove('hidden');
            
            if (isCorrect) {
                resultEl.className = 'mt-6 p-4 rounded-xl bg-green-500/20 border border-green-500/50';
                resultEl.innerHTML = `
                    <div class="flex items-center gap-2 text-green-400 font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        答對了！
                    </div>
                `;
            } else {
                resultEl.className = 'mt-6 p-4 rounded-xl bg-red-500/20 border border-red-500/50';
                resultEl.innerHTML = `
                    <div class="flex items-center gap-2 text-red-400 font-semibold mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        答錯了！
                    </div>
                    <p class="text-slate-300">
                        正確答案：<span class="text-green-400 font-bold">${question.correctAnswer}</span>
                    </p>
                `;
            }
        }

        // ==================== 導航功能 ====================
        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                renderQuestion();
            }
        }

        function jumpToQuestion() {
            const input = document.getElementById('jumpInput');
            const num = parseInt(input.value);
            
            // 尋找對應題號的索引
            const index = questions.findIndex(q => q.number === num);
            if (index !== -1) {
                currentIndex = index;
                renderQuestion();
            } else {
                alert(`找不到第 ${num} 題`);
            }
        }

        function updateJumpInputMax() {
            const input = document.getElementById('jumpInput');
            if (questions.length > 0) {
                input.max = questions[questions.length - 1].number;
            }
        }

        // ==================== 翻譯切換 ====================
        function toggleTranslation() {
            showChinese = !showChinese;
            renderQuestion();
        }

        // ==================== 統計功能 ====================
        function updateStats() {
            let correct = 0;
            let wrong = 0;
            
            for (const num in answerState) {
                if (answerState[num] === 'correct') correct++;
                else if (answerState[num] === 'wrong') wrong++;
            }
            
            const total = correct + wrong;
            const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
            
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            // 更新進度條
            const progressPercent = questions.length > 0 ? (total / questions.length) * 100 : 0;
            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = `已作答 ${total} / ${questions.length} 題`;
        }

        // ==================== 進度儲存 ====================
        function saveProgress() {
            localStorage.setItem('sy0701_answerState', JSON.stringify(answerState));
            localStorage.setItem('sy0701_currentIndex', currentIndex.toString());
        }

        function loadSavedProgress() {
            try {
                const saved = localStorage.getItem('sy0701_answerState');
                if (saved) {
                    answerState = JSON.parse(saved);
                }
                const savedIndex = localStorage.getItem('sy0701_currentIndex');
                if (savedIndex !== null) {
                    currentIndex = parseInt(savedIndex);
                    // 確保索引在有效範圍內
                    if (currentIndex >= questions.length) {
                        currentIndex = 0;
                    }
                }
            } catch (e) {
                console.log('載入進度失敗');
            }
        }

        function resetProgress() {
            if (confirm('確定要重設所有答題進度嗎？')) {
                answerState = {};
                currentIndex = 0;
                localStorage.removeItem('sy0701_answerState');
                localStorage.removeItem('sy0701_currentIndex');
                generateAnswerCard();
                renderQuestion();
                updateStats();
            }
        }

        // ==================== 工具函式 ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== 解析面板控制（懸浮視窗） ====================
        let isExplanationPanelOpen = false;
        let explanationPanelDragging = false;
        let explanationPanelOffsetX = 0;
        let explanationPanelOffsetY = 0;

        /**
         * 初始化懸浮解析視窗拖曳功能
         */
        function initExplanationPanelDrag() {
            const panel = document.getElementById('explanationPanel');
            const header = document.getElementById('explanationPanelHeader');

            header.addEventListener('mousedown', startExplanationPanelDrag);
            document.addEventListener('mousemove', dragExplanationPanel);
            document.addEventListener('mouseup', stopExplanationPanelDrag);

            // 觸控支援
            header.addEventListener('touchstart', startExplanationPanelDragTouch, { passive: false });
            document.addEventListener('touchmove', dragExplanationPanelTouch, { passive: false });
            document.addEventListener('touchend', stopExplanationPanelDrag);
        }

        function startExplanationPanelDrag(e) {
            const panel = document.getElementById('explanationPanel');
            explanationPanelDragging = true;
            explanationPanelOffsetX = e.clientX - panel.offsetLeft;
            explanationPanelOffsetY = e.clientY - panel.offsetTop;
            panel.style.transition = 'none';
        }

        function startExplanationPanelDragTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const panel = document.getElementById('explanationPanel');
            explanationPanelDragging = true;
            explanationPanelOffsetX = touch.clientX - panel.offsetLeft;
            explanationPanelOffsetY = touch.clientY - panel.offsetTop;
            panel.style.transition = 'none';
        }

        function dragExplanationPanel(e) {
            if (!explanationPanelDragging) return;
            e.preventDefault();
            const panel = document.getElementById('explanationPanel');
            let newX = e.clientX - explanationPanelOffsetX;
            let newY = e.clientY - explanationPanelOffsetY;

            // 限制在視窗範圍內
            newX = Math.max(0, Math.min(newX, window.innerWidth - panel.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - panel.offsetHeight));

            panel.style.left = newX + 'px';
            panel.style.top = newY + 'px';
        }

        function dragExplanationPanelTouch(e) {
            if (!explanationPanelDragging) return;
            e.preventDefault();
            const touch = e.touches[0];
            const panel = document.getElementById('explanationPanel');
            let newX = touch.clientX - explanationPanelOffsetX;
            let newY = touch.clientY - explanationPanelOffsetY;

            // 限制在視窗範圍內
            newX = Math.max(0, Math.min(newX, window.innerWidth - panel.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - panel.offsetHeight));

            panel.style.left = newX + 'px';
            panel.style.top = newY + 'px';
        }

        function stopExplanationPanelDrag() {
            if (explanationPanelDragging) {
                explanationPanelDragging = false;
                const panel = document.getElementById('explanationPanel');
                panel.style.transition = '';
            }
        }

        /**
         * 切換解析面板顯示
         */
        function toggleExplanationPanel() {
            if (isExplanationPanelOpen) {
                closeExplanationPanel();
            } else {
                openExplanationPanel();
            }
        }

        /**
         * 開啟解析面板（懸浮視窗）
         */
        function openExplanationPanel() {
            const q = questions[currentIndex];
            if (!q || !q.explanation) return;

            const panel = document.getElementById('explanationPanel');
            const content = document.getElementById('explanationContent');
            const questionNumSpan = document.getElementById('explanationQuestionNum');

            // 使用 marked.js 解析 Markdown
            if (typeof marked !== 'undefined') {
                // 設定 marked 選項
                marked.setOptions({
                    breaks: true,       // 支援換行
                    gfm: true,          // GitHub Flavored Markdown
                    headerIds: false,   // 不自動產生標題 ID
                    mangle: false       // 不編碼郵件地址
                });
                content.innerHTML = marked.parse(q.explanation);
            } else {
                // 降級處理：簡單替換
                content.innerHTML = q.explanation.replace(/\n/g, '<br>');
            }

            // 更新題號顯示
            questionNumSpan.textContent = `第 ${q.number} 題`;

            // 顯示懸浮視窗
            panel.classList.remove('hidden');

            // 重設位置到螢幕左邊（預設位置）
            panel.style.left = '16px';
            panel.style.top = '100px';

            // 更新按鈕狀態
            const btn = document.getElementById('explanationBtn');
            btn.classList.add('bg-amber-500/40');
            btn.classList.remove('bg-amber-500/20');

            isExplanationPanelOpen = true;
        }

        /**
         * 關閉解析面板
         */
        function closeExplanationPanel() {
            const panel = document.getElementById('explanationPanel');

            // 隱藏懸浮視窗
            panel.classList.add('hidden');

            // 更新按鈕狀態
            const btn = document.getElementById('explanationBtn');
            if (btn) {
                btn.classList.remove('bg-amber-500/40');
                btn.classList.add('bg-amber-500/20');
            }

            isExplanationPanelOpen = false;
        }

        // ==================== 圖片 Dialog 控制 ====================
        // 縮放與拖曳狀態
        let imageScale = 1;
        let imageTranslateX = 0;
        let imageTranslateY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragStartTranslateX = 0;
        let dragStartTranslateY = 0;

        /**
         * 開啟圖片 Dialog
         */
        function openImageDialog() {
            const dialog = document.getElementById('imageDialog');
            dialog.classList.remove('hidden');
            // 禁止背景滾動
            document.body.style.overflow = 'hidden';
            // 重設縮放與位置
            resetZoom();
        }

        /**
         * 關閉圖片 Dialog
         */
        function closeImageDialog() {
            const dialog = document.getElementById('imageDialog');
            dialog.classList.add('hidden');
            // 恢復背景滾動
            document.body.style.overflow = '';
        }

        /**
         * 處理點擊背景關閉
         */
        function handleDialogBackdropClick(event) {
            // 只有點擊最外層才關閉
            if (event.target.id === 'imageDialog') {
                closeImageDialog();
            }
        }

        /**
         * 更新圖片變換
         * @param {boolean} smooth - 是否使用平滑過渡
         */
        function updateImageTransform(smooth = true) {
            const img = document.getElementById('dialogImageSrc');
            // 拖曳時禁用 transition 避免抖動
            img.style.transition = smooth ? 'transform 0.1s ease-out' : 'none';
            img.style.transform = `translate(${imageTranslateX}px, ${imageTranslateY}px) scale(${imageScale})`;
            document.getElementById('zoomLevel').textContent = Math.round(imageScale * 100) + '%';
        }

        /**
         * 放大
         */
        function zoomIn() {
            if (imageScale < 5) {
                imageScale = Math.min(5, imageScale + 0.25);
                updateImageTransform();
            }
        }

        /**
         * 縮小
         */
        function zoomOut() {
            if (imageScale > 0.25) {
                imageScale = Math.max(0.25, imageScale - 0.25);
                updateImageTransform();
            }
        }

        /**
         * 重設縮放與位置
         */
        function resetZoom() {
            imageScale = 1;
            imageTranslateX = 0;
            imageTranslateY = 0;
            updateImageTransform();
        }

        /**
         * 滾輪縮放
         */
        function handleWheel(event) {
            event.preventDefault();
            const delta = event.deltaY > 0 ? -0.1 : 0.1;
            const newScale = Math.max(0.25, Math.min(5, imageScale + delta));
            imageScale = newScale;
            updateImageTransform();
        }

        /**
         * 開始拖曳
         */
        function startDrag(event) {
            event.preventDefault();
            isDragging = true;
            dragStartX = event.clientX;
            dragStartY = event.clientY;
            dragStartTranslateX = imageTranslateX;
            dragStartTranslateY = imageTranslateY;
            // 禁用 transition
            const img = document.getElementById('dialogImageSrc');
            img.style.transition = 'none';
        }

        /**
         * 拖曳中
         */
        function onDrag(event) {
            if (!isDragging) return;
            event.preventDefault();
            const dx = event.clientX - dragStartX;
            const dy = event.clientY - dragStartY;
            imageTranslateX = dragStartTranslateX + dx;
            imageTranslateY = dragStartTranslateY + dy;
            // 拖曳時不使用 transition
            updateImageTransform(false);
        }

        /**
         * 結束拖曳
         */
        function endDrag() {
            if (isDragging) {
                isDragging = false;
                // 恢復 transition
                const img = document.getElementById('dialogImageSrc');
                img.style.transition = 'transform 0.1s ease-out';
            }
        }

        // ESC 鍵關閉 Dialog 和懸浮視窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageDialog();
                closeSettingsDialog();
                closeExplanationPanel();
            }
        });

        // 點擊其他地方關閉模型下拉選單
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('modelDropdown');
            const input = document.getElementById('modelSearchInput');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.add('hidden');
            }
        });

        // ==================== GROQ 設定 Dialog ====================
        /**
         * 開啟設定 Dialog
         */
        function openSettingsDialog() {
            const dialog = document.getElementById('settingsDialog');
            dialog.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // 載入已儲存的設定
            const savedKey = localStorage.getItem('groq_api_key');
            const savedModel = localStorage.getItem('groq_model');
            const savedPrompt = localStorage.getItem('groq_custom_prompt');
            
            if (savedKey) {
                document.getElementById('groqApiKeyInput').value = savedKey;
                groqApiKey = savedKey;
            }
            if (savedModel) {
                groqModel = savedModel;
                document.getElementById('currentModelName').textContent = savedModel;
            }
            if (savedPrompt) {
                document.getElementById('customPromptInput').value = savedPrompt;
            } else {
                // 沒有儲存的自訂提示詞時，顯示系統預設提示詞
                document.getElementById('customPromptInput').value = AI_SYSTEM_PROMPT;
            }
            
            // 如果已有 API Key，顯示模型選擇和進階設定
            if (groqApiKey) {
                document.getElementById('modelSelectContainer').classList.remove('hidden');
                document.getElementById('advancedSettingsContainer').classList.remove('hidden');
                document.getElementById('apiKeyStatus').textContent = 'API Key 已儲存';
                document.getElementById('apiKeyStatus').className = 'mt-2 text-xs text-green-400';
                // 自動載入模型列表
                if (availableModels.length === 0) {
                    fetchModels();
                }
            }
        }

        /**
         * 關閉設定 Dialog
         */
        function closeSettingsDialog() {
            const dialog = document.getElementById('settingsDialog');
            dialog.classList.add('hidden');
            document.body.style.overflow = '';
        }

        /**
         * 處理設定 Dialog 背景點擊
         */
        function handleSettingsBackdropClick(event) {
            if (event.target.id === 'settingsDialog') {
                closeSettingsDialog();
            }
        }

        /**
         * 驗證 API Key 並載入模型
         */
        async function verifyApiKey() {
            const input = document.getElementById('groqApiKeyInput');
            const btn = document.getElementById('verifyApiKeyBtn');
            const spinner = document.getElementById('verifySpinner');
            const btnText = document.getElementById('verifyBtnText');
            const status = document.getElementById('apiKeyStatus');
            
            const apiKey = input.value.trim();
            if (!apiKey) {
                status.textContent = '請輸入 API Key';
                status.className = 'mt-2 text-xs text-red-400';
                return;
            }
            
            // 顯示載入狀態
            btn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = '驗證中';
            status.textContent = '正在驗證 API Key...';
            status.className = 'mt-2 text-xs text-slate-400';
            
            try {
                groqApiKey = apiKey;
                await fetchModels();
                
                // 顯示模型選擇和進階設定
                document.getElementById('modelSelectContainer').classList.remove('hidden');
                document.getElementById('advancedSettingsContainer').classList.remove('hidden');
                status.textContent = 'API Key 驗證成功！請選擇模型';
                status.className = 'mt-2 text-xs text-green-400';
            } catch (error) {
                status.textContent = '驗證失敗：' + error.message;
                status.className = 'mt-2 text-xs text-red-400';
                groqApiKey = '';
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = '確認';
            }
        }

        /**
         * 從 GROQ API 獲取可用模型列表
         */
        async function fetchModels() {
            const response = await fetch('https://api.groq.com/openai/v1/models', {
                headers: {
                    'Authorization': `Bearer ${groqApiKey}`
                }
            });
            
            if (!response.ok) {
                throw new Error('無法獲取模型列表');
            }
            
            const data = await response.json();
            availableModels = data.data.map(m => ({
                id: m.id,
                name: m.id,
                owned_by: m.owned_by || ''
            })).sort((a, b) => a.id.localeCompare(b.id));
            
            renderModelDropdown(availableModels);
        }

        /**
         * 渲染模型下拉選單
         */
        function renderModelDropdown(models) {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.innerHTML = '';
            
            if (models.length === 0) {
                dropdown.innerHTML = '<div class="px-4 py-3 text-slate-500 text-sm">找不到模型</div>';
                return;
            }
            
            models.forEach(model => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2.5 hover:bg-slate-700 cursor-pointer transition text-sm';
                if (model.id === groqModel) {
                    div.className += ' bg-blue-600/20 text-blue-400';
                }
                div.innerHTML = `
                    <div class="font-medium">${model.id}</div>
                    ${model.owned_by ? `<div class="text-xs text-slate-500">${model.owned_by}</div>` : ''}
                `;
                div.onclick = () => selectModel(model.id);
                dropdown.appendChild(div);
            });
        }

        /**
         * 顯示模型下拉選單
         */
        function showModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.classList.remove('hidden');
            if (availableModels.length > 0) {
                renderModelDropdown(availableModels);
            }
        }

        /**
         * 過濾模型列表
         */
        function filterModels() {
            const input = document.getElementById('modelSearchInput');
            const keyword = input.value.toLowerCase().trim();
            
            const filtered = availableModels.filter(m => 
                m.id.toLowerCase().includes(keyword) || 
                (m.owned_by && m.owned_by.toLowerCase().includes(keyword))
            );
            
            renderModelDropdown(filtered);
            document.getElementById('modelDropdown').classList.remove('hidden');
        }

        /**
         * 選擇模型
         */
        function selectModel(modelId) {
            groqModel = modelId;
            document.getElementById('modelSearchInput').value = modelId;
            document.getElementById('currentModelName').textContent = modelId;
            document.getElementById('modelDropdown').classList.add('hidden');
        }

        /**
         * 儲存設定
         */
        /**
         * 切換進階設定展開/收合
         */
        function toggleAdvancedSettings() {
            const content = document.getElementById('advancedSettingsContent');
            const icon = document.getElementById('advancedSettingsIcon');
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        /**
         * 載入系統預設提示詞
         */
        function loadSystemPrompt() {
            document.getElementById('customPromptInput').value = AI_SYSTEM_PROMPT;
        }

        /**
         * 重置自訂提示詞（清空）
         */
        function resetCustomPrompt() {
            document.getElementById('customPromptInput').value = '';
        }

        /**
         * 儲存設定
         */
        function saveSettings() {
            if (!groqApiKey) {
                alert('請先輸入並驗證 API Key');
                return;
            }
            
            let customPrompt = document.getElementById('customPromptInput').value.trim();
            
            // 如果內容等於系統預設提示詞，儲存為空（表示使用系統預設）
            if (customPrompt === AI_SYSTEM_PROMPT.trim()) {
                customPrompt = '';
            }
            
            localStorage.setItem('groq_api_key', groqApiKey);
            localStorage.setItem('groq_model', groqModel);
            localStorage.setItem('groq_custom_prompt', customPrompt);
            
            closeSettingsDialog();
        }

        // ==================== AI 解析功能 ====================
        const AI_SYSTEM_PROMPT = `你是一個具備專業知識的考題解析專家，專門用於題庫練習與學習知識輔助。

你的任務是：
1. 仔細閱讀「題目內容」與「所有選項」
2. 僅根據題目條件與邏輯推論作答，不可憑空猜測
3. 明確選出一個最正確的答案
4. 提供清楚、結構化、可學習的解析說明
5. 全程使用「繁體中文」回覆

請嚴格依照以下輸出格式回答（不得省略段落標題）：

--------------------------------
正確答案：<請填入選項代號，例如 A / B / C / D>

解析：
<說明為何該選項符合題目條件，需具備邏輯推導與關鍵判斷依據>

題目條件關鍵：
1. <從題目中萃取的關鍵條件或限制>
2. <重要的技術名詞、規則、前提或情境>
（如有更多關鍵條件可自行補充）

各選項比較：
A. <選項內容簡述與判斷原因> ❌ / ✅
B. <選項內容簡述與判斷原因> ❌ / ✅
C. <選項內容簡述與判斷原因> ❌ / ✅
D. <選項內容簡述與判斷原因> ❌ / ✅

結論：
<總結分析，說明為何正確答案在所有選項中是最佳且最符合題意的選擇>
--------------------------------

補充規則：
- 若題目為單選題，只能有一個「正確答案」
- 若題目為多選題，需列出所有正確選項
- 若題目描述不足或有歧義，請以「最符合一般考試標準解釋」進行判斷
- 各選項說明請保持簡短、精準、可比較
- 不要加入與題目無關的延伸知識`;

        /**
         * 使用 AI 分析當前題目
         */
        async function analyzeWithAI() {
            // 檢查 API Key
            if (!groqApiKey) {
                const savedKey = localStorage.getItem('groq_api_key');
                if (savedKey) {
                    groqApiKey = savedKey;
                } else {
                    alert('請先在設定中配置 GROQ API Key');
                    openSettingsDialog();
                    return;
                }
            }
            
            // 載入已儲存的模型和自訂提示詞
            const savedModel = localStorage.getItem('groq_model');
            const savedPrompt = localStorage.getItem('groq_custom_prompt');
            if (savedModel) {
                groqModel = savedModel;
            }
            
            // 決定使用的提示詞
            let systemPrompt = AI_SYSTEM_PROMPT;
            if (savedPrompt && savedPrompt.trim() && savedPrompt.trim() !== '請使用系統原生提示詞') {
                systemPrompt = savedPrompt.trim();
            }
            
            // 取得當前題目
            const q = questions[currentIndex];
            if (!q) return;
            
            // 顯示區塊並設定載入狀態
            const section = document.getElementById('aiAnalysisSection');
            const loading = document.getElementById('aiAnalysisLoading');
            const content = document.getElementById('aiAnalysisContent');
            const error = document.getElementById('aiAnalysisError');
            
            section.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            error.classList.add('hidden');
            
            // 滾動到 AI 解析區塊
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // 組合題目內容
            const optionsText = q.options.map(opt => `${opt.letter}. ${opt.text}`).join('\n');
            const userPrompt = `題目類型：${q.type}

題目：
${q.englishText}

${q.chineseText ? `中文翻譯：\n${q.chineseText}\n` : ''}
選項：
${optionsText}`;
            
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${groqApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: groqModel,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 2048
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API 請求失敗 (${response.status})`);
                }
                
                const data = await response.json();
                const result = data.choices[0]?.message?.content || '無法取得回應';
                
                // 顯示結果
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                content.innerHTML = formatAiResponse(result);
                
            } catch (err) {
                console.error('AI 分析錯誤:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                document.getElementById('aiAnalysisErrorMsg').textContent = err.message;
            }
        }

        /**
         * 隱藏 AI 解析區塊
         */
        function hideAiAnalysis() {
            document.getElementById('aiAnalysisSection').classList.add('hidden');
        }

        /**
         * 格式化 AI 回應（簡易 Markdown 轉 HTML）
         */
        function formatAiResponse(text) {
            // 移除開頭的分隔線
            let processed = text.replace(/^-{3,}\s*\n?/gm, '').trim();
            
            // 先轉義 HTML
            processed = processed
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // 按行處理
            const lines = processed.split('\n');
            const result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // 跳過空行和分隔線
                if (!line || /^-{3,}$/.test(line)) {
                    if (line && result.length > 0) {
                        result.push('<div class="h-2"></div>');
                    }
                    continue;
                }
                
                // 正確答案（優先匹配）
                if (/^正確答案[：:]/.test(line)) {
                    const match = line.match(/正確答案[：:]\s*(.+)/);
                    if (match) {
                        result.push(`<div class="bg-green-500/10 border-l-4 border-green-500 px-4 py-3 rounded-r-lg mb-4"><div class="text-lg font-bold text-green-400 mb-1">✓ 正確答案</div><div class="text-2xl font-bold text-green-300 tracking-wider">${match[1]}</div></div>`);
                    }
                    continue;
                }
                
                // 段落標題
                if (/^(解析|題目條件關鍵|各選項比較|結論)[：:]/.test(line)) {
                    const match = line.match(/^(解析|題目條件關鍵|各選項比較|結論)[：:]/);
                    if (match) {
                        result.push(`<div class="mt-6 mb-3 first:mt-0"><h4 class="text-lg font-bold text-blue-400 flex items-center gap-2"><span class="w-1 h-5 bg-blue-400 rounded"></span>${match[1]}</h4></div>`);
                    }
                    continue;
                }
                
                // 選項行（帶 ✅ 或 ❌）
                const optionMatch = line.match(/^([A-F])\.\s+(.+?)(✅|❌)$/);
                if (optionMatch) {
                    const [, letter, content, emoji] = optionMatch;
                    const isCorrect = emoji === '✅';
                    const bgClass = isCorrect ? 'bg-green-500/10 border-green-500/30' : 'bg-slate-800/50 border-slate-700/50';
                    const textClass = isCorrect ? 'text-green-300' : 'text-gray-400';
                    const letterClass = isCorrect ? 'text-green-400' : 'text-slate-500';
                    result.push(`<div class="ml-4 my-2.5 p-3 rounded-lg border ${bgClass} flex items-start gap-3"><span class="font-bold ${letterClass} text-lg shrink-0">${letter}.</span><span class="flex-1 ${textClass} leading-relaxed">${content}</span><span class="text-xl shrink-0">${emoji}</span></div>`);
                    continue;
                }
                
                // 列表項
                const listMatch = line.match(/^(\d+)\.\s+(.+)$/);
                if (listMatch) {
                    result.push(`<div class="ml-6 my-2 flex items-start gap-2"><span class="text-blue-400 font-semibold shrink-0">${listMatch[1]}.</span><span class="text-gray-300 leading-relaxed">${listMatch[2]}</span></div>`);
                    continue;
                }
                
                // 一般文字（處理粗體）
                let formattedLine = line.replace(/\*\*(.+?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');
                
                // 如果前一行不是特殊格式，添加適當的間距和樣式
                if (result.length > 0 && !result[result.length - 1].includes('class="mt-6') && !result[result.length - 1].includes('class="bg-')) {
                    formattedLine = `<div class="mb-2.5 text-gray-300 leading-relaxed text-base">${formattedLine}</div>`;
                } else {
                    formattedLine = `<div class="text-gray-300 leading-relaxed text-base">${formattedLine}</div>`;
                }
                
                result.push(formattedLine);
            }
            
            return result.join('');
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', () => {
            // 載入已儲存的 GROQ 設定
            const savedKey = localStorage.getItem('groq_api_key');
            const savedModel = localStorage.getItem('groq_model');
            if (savedKey) groqApiKey = savedKey;
            if (savedModel) groqModel = savedModel;

            // 初始化懸浮解析視窗拖曳功能
            initExplanationPanelDrag();

            autoLoadQuestions();
        });
    </script>
</body>
</html>

